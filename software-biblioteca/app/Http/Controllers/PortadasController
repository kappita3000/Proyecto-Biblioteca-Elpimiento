<?php
namespace App\Http\Controllers;

use Illuminate\Http\Request;
use App\Models\Libro;
use Illuminate\Support\Facades\Http;

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use App\Models\Libro;
use Illuminate\Support\Facades\Http;

class PortadasController extends Controller
{
    // Función para mostrar la lista de libros con la carátula
    public function index()
    {
        // Obtener todos los libros de la base de datos
        $libros = Libro::with('genero', 'autor', 'categoria', 'editorial', 'repisa')->get();

        // Recorrer cada libro y obtener la carátula desde Open Library
        foreach ($libros as $libro) {
            // Dividir el título en palabras y usar solo las primeras tres palabras para la búsqueda
            $palabrasTitulo = explode(' ', $libro->titulo);
            $tituloParaBusqueda = implode(' ', array_slice($palabrasTitulo, 0, 3));
            $tituloParaBusqueda = urlencode($tituloParaBusqueda); // Usamos `urlencode` para manejar espacios y caracteres especiales

            // Obtener el nombre del autor para la búsqueda
            $nombreAutor = $libro->autor ? urlencode($libro->autor->nombre) : '';

            // Hacer una petición GET a la API de Open Library para buscar por título y autor
            $response = Http::get("https://openlibrary.org/search.json?title={$tituloParaBusqueda}&author={$nombreAutor}");

            // Verificar que la respuesta sea correcta y contenga libros
            if ($response->successful() && isset($response['docs']) && count($response['docs']) > 0) {
                // Obtener el primer libro de los resultados
                $resultado = $response['docs'][0];

                // Verificar si existe una OLID en el resultado para generar la URL de la carátula
                if (isset($resultado['cover_edition_key'])) {
                    $olid = $resultado['cover_edition_key'];
                    // Crear la URL de la carátula usando el OLID
                    $libro->caratula = "https://covers.openlibrary.org/b/olid/{$olid}-M.jpg";
                } else {
                    // En caso de no encontrar la OLID, usar una imagen placeholder
                    $libro->caratula = asset('img/placeholder.png');
                }
            } else {
                // En caso de fallo, usar una imagen placeholder
                $libro->caratula = asset('img/placeholder.png');
            }
        }

        return view('libros.index', compact('libros'));
    }
}


?>